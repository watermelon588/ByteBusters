<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>NGOs Near Me â€” Live Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Leaflet CSS/JS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <style>
    :root {
      --panel-h: 56px;
    }
    html, body {
      height: 100%;
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: #f7f7f8;
    }
    .topbar {
      height: var(--panel-h);
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 8px 12px;
      background: #ffffff;
      border-bottom: 1px solid #e5e7eb;
      position: sticky;
      top: 0;
      z-index: 1000;
    }
    .topbar h1 {
      font-size: 16px;
      margin: 0 12px 0 0;
      font-weight: 600;
    }
    .topbar select, .topbar button {
      height: 36px;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      background: #fff;
      padding: 0 10px;
      cursor: pointer;
    }
    .topbar button {
      background: #10b981;
      color: #fff;
      border: none;
      font-weight: 600;
    }
    .layout {
      display: grid;
      grid-template-columns: 1fr 340px;
      gap: 8px;
      height: calc(100vh - var(--panel-h));
    }
    #map {
      height: 100%;
      width: 100%;
      background: #e5e7eb;
    }
    .sidebar {
      background: #fff;
      border-left: 1px solid #e5e7eb;
      overflow: auto;
      padding: 8px;
    }
    .sidebar h2 {
      font-size: 14px;
      margin: 6px 0 10px;
      color: #111827;
    }
    .result {
      border: 1px solid #e5e7eb;
      border-radius: 10px;
      padding: 8px 10px;
      margin-bottom: 8px;
      cursor: pointer;
      transition: background 0.15s ease;
    }
    .result:hover { background: #f9fafb; }
    .result .name { font-weight: 600; font-size: 14px; color: #111827; }
    .result .meta { font-size: 12px; color: #6b7280; margin-top: 3px; }
    .footer {
      font-size: 12px;
      color: #6b7280;
      margin-top: 10px;
    }
    @media (max-width: 900px) {
      .layout { grid-template-columns: 1fr; }
      .sidebar { height: 40vh; }
      #map { height: 60vh; }
    }
  </style>
</head>
<body>
  <div class="topbar">
    <h1>NGOs near me</h1>
    <label>Radius
      <select id="radius">
        <option value="2000">2 km</option>
        <option value="3000" selected>3 km</option>
        <option value="5000">5 km</option>
        <option value="8000">8 km</option>
        <option value="10000">10 km</option>
      </select>
    </label>
    <button id="refresh">Refresh</button>
    <span id="status" style="margin-left:auto;color:#6b7280;font-size:12px;">Waiting for locationâ€¦</span>
  </div>

  <div class="layout">
    <div id="map"></div>
    <aside class="sidebar">
      <h2><span id="count">0</span> results</h2>
      <div id="list"></div>
      <div class="footer">Data Â© OpenStreetMap contributors â€¢ Overpass API</div>
    </aside>
  </div>

  <script>
    // --- Map init ---
    const map = L.map('map', { zoomControl: true });
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap'
    }).addTo(map);

    let userMarker, accuracyCircle, watchId;
    const ngoLayer = L.layerGroup().addTo(map);
    const statusEl = document.getElementById('status');
    const listEl = document.getElementById('list');
    const countEl = document.getElementById('count');
    const radiusEl = document.getElementById('radius');
    const refreshBtn = document.getElementById('refresh');

    // Track last query center to avoid spamming Overpass
    let lastQuery = { lat: null, lng: null, radius: null };

    // --- Geolocation (live) ---
    function startTracking() {
      if (!navigator.geolocation) {
        statusEl.textContent = 'Geolocation not supported.';
        return;
      }
      watchId = navigator.geolocation.watchPosition(onPosition, onGeoError, {
        enableHighAccuracy: true,
        maximumAge: 10000,
        timeout: 15000
      });
    }

    function onPosition(pos) {
      const { latitude: lat, longitude: lng, accuracy } = pos.coords;

      // Place/update user marker + accuracy circle
      if (!userMarker) {
        userMarker = L.marker([lat, lng], { title: 'You are here' }).addTo(map);
        accuracyCircle = L.circle([lat, lng], { radius: accuracy, color: '#2563eb', fillColor: '#3b82f6', fillOpacity: 0.15 }).addTo(map);
        map.setView([lat, lng], 14);
      } else {
        userMarker.setLatLng([lat, lng]);
        accuracyCircle.setLatLng([lat, lng]).setRadius(accuracy);
      }

      statusEl.textContent = `Live: ${lat.toFixed(4)}, ${lng.toFixed(4)} (Â±${Math.round(accuracy)}m)`;

      // Query NGOs if moved > ~200m or radius changed
      const r = Number(radiusEl.value);
      if (shouldQuery(lat, lng, r)) {
        fetchNGOs(lat, lng, r);
        lastQuery = { lat, lng, radius: r };
      }
    }

    function onGeoError(err) {
      statusEl.textContent = 'Location error: ' + err.message;
    }

    function distMeters(lat1, lng1, lat2, lng2) {
      // Haversine (approx)
      const toRad = d => d * Math.PI / 180;
      const R = 6371000;
      const dLat = toRad(lat2 - lat1);
      const dLng = toRad(lng2 - lng1);
      const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLng/2)**2;
      return 2 * R * Math.asin(Math.sqrt(a));
    }
    function shouldQuery(lat, lng, r) {
      if (lastQuery.lat === null) return true;
      const moved = distMeters(lat, lng, lastQuery.lat, lastQuery.lng);
      return moved > 200 || r !== lastQuery.radius; // re-query if moved >200m or radius changed
    }

    // --- Overpass query for NGOs ---
    async function fetchNGOs(lat, lng, radiusMeters) {
      statusEl.textContent = 'Searching NGOsâ€¦';

      // Overpass QL: search nodes/ways/relations with NGO-ish tags around the point
      const q = `
        [out:json][timeout:30];
        (
          node(around:${radiusMeters},${lat},${lng})["office"="ngo"];
          way(around:${radiusMeters},${lat},${lng})["office"="ngo"];
          relation(around:${radiusMeters},${lat},${lng})["office"="ngo"];

          node(around:${radiusMeters},${lat},${lng})["non_profit"="yes"];
          way(around:${radiusMeters},${lat},${lng})["non_profit"="yes"];
          relation(around:${radiusMeters},${lat},${lng})["non_profit"="yes"];

          node(around:${radiusMeters},${lat},${lng})["charity"];
          way(around:${radiusMeters},${lat},${lng})["charity"];
          relation(around:${radiusMeters},${lat},${lng})["charity"];
        );
        out center tags;
      `.trim();

      try {
        const res = await fetch('https://overpass-api.de/api/interpreter', {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8' },
          body: 'data=' + encodeURIComponent(q)
        });
        const json = await res.json();
        renderResults(json.elements || []);
        statusEl.textContent = 'Done.';
      } catch (e) {
        console.error(e);
        statusEl.textContent = 'Search failed. Try again.';
      }
    }

    function renderResults(elements) {
      ngoLayer.clearLayers();
      listEl.innerHTML = '';
      countEl.textContent = elements.length;

      if (!elements.length) return;

      elements.forEach((el, idx) => {
        const tags = el.tags || {};
        const name = tags.name || 'Unnamed NGO';
        const lat = el.lat || el.center?.lat;
        const lng = el.lon || el.center?.lon;
        if (lat == null || lng == null) return;

        const website = tags.website || tags['contact:website'];
        const phone = tags.phone || tags['contact:phone'];
        const addr = [tags['addr:housenumber'], tags['addr:street'], tags['addr:city']].filter(Boolean).join(' ') || tags['addr:full'] || '';

        // Marker + popup
        const m = L.marker([lat, lng]).addTo(ngoLayer);
        const popupHtml = `
          <strong>${escapeHtml(name)}</strong><br/>
          ${addr ? escapeHtml(addr) + '<br/>' : ''}
          ${phone ? 'ðŸ“ž ' + escapeHtml(phone) + '<br/>' : ''}
          ${website ? `<a href="${escapeAttr(website)}" target="_blank" rel="noopener">Website</a>` : ''}
        `;
        m.bindPopup(popupHtml);

        // List item
        const div = document.createElement('div');
        div.className = 'result';
        div.innerHTML = `
          <div class="name">${escapeHtml(name)}</div>
          <div class="meta">
            ${addr ? escapeHtml(addr) + ' â€¢ ' : ''}${phone ? 'ðŸ“ž ' + escapeHtml(phone) : ''}
          </div>
        `;
        div.addEventListener('click', () => {
          map.setView([lat, lng], 16);
          m.openPopup();
        });
        listEl.appendChild(div);
      });
    }

    function escapeHtml(s='') {
      return s.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
    }
    function escapeAttr(s='') { return s.replace(/"/g, '&quot;'); }

    // --- UI handlers ---
    refreshBtn.addEventListener('click', () => {
      if (!userMarker) return;
      const { lat, lng } = userMarker.getLatLng();
      fetchNGOs(lat, lng, Number(radiusEl.value));
    });
    radiusEl.addEventListener('change', () => {
      if (!userMarker) return;
      const { lat, lng } = userMarker.getLatLng();
      fetchNGOs(lat, lng, Number(radiusEl.value));
    });

    // Start
    startTracking();
  </script>
</body>
</html>
